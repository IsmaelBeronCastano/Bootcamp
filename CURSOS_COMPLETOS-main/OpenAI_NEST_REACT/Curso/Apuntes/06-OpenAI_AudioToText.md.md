# OpenAI Nest + React - Audio a texto

- *NOTA*: en la sección de frontend están el resto de componentes de la aplicación no mostrados en la documentación anterior

- AudiToTextUseCase

~~~js
import * as fs from 'fs';

import OpenAI from 'openai';

interface Options {
  prompt?: string; //el prompt será opcional
  audioFile: Express.Multer.File;
}


export const audioToTextUseCase = async( openai:OpenAI, options: Options ) => {
  
  const { prompt, audioFile} = options;

  // console.log({ prompt, audioFile });

  const response = await openai.audio.transcriptions.create({
    model: 'whisper-1',
    file: fs.createReadStream( audioFile.path ),
    prompt: prompt, // mismo idioma del audio
    language: 'es',//DEBE SEGUIR EL ISO6391. Debe de estar en el mismo idioma que el audio
    // response_format: 'vtt', // 'srt',
    response_format: 'verbose_json',
  })


  return response;

}
~~~

- En el controller
- Uso un audio de menos de 25 MB
- diskStorage viene de multer (npm i multer)
- Debo pasarlke el prompt y el file en POSTMAN

~~~js
  @Post('audio-to-text')
  @UseInterceptors(
    FileInterceptor('file', { //intercepto el file
      storage: diskStorage({ //uso diskStorage para indicar la ubicación de destino
        destination: './generated/uploads',
        filename: (req, file, callback) => {
          const fileExtension = file.originalname.split('.').pop(); //extraigo la extensión
          const fileName = `${ new Date().getTime() }.${ fileExtension }`;//creoi el nombre del archivo
          return callback(null, fileName);
        }
      })//no estamos validando que sea una extensión permitida, lo validamos en el método de abajo
    })
  )
  async audioToText(
    @UploadedFile(//uso este decorador para trabajar con el file subido
      new ParseFilePipe({ //hago la validación
        validators: [
          new MaxFileSizeValidator({ maxSize: 1000 * 1024 * 5, message: 'File is bigger than 5 mb ' }),//defino el tamaño máximo (5MB)
          new FileTypeValidator({ fileType: 'audio/*' })//que sea cualquier tipo audio
        ]
      })
    ) file: Express.Multer.File,
  ) {
    
    return this.gptService.audioToText(file); //esto regresará algo de tipo Edxpress.Multer.File
  }
~~~

- gpt.service

~~~js
async audioToText( audioFile: Express.Multer.File, prompt?: string ) {
return await audioToTextUseCase( this.openai, { audioFile, prompt } );
}
~~~

- De esta manera regresará un archivo de texto a modo de subtitulos indicando de que segundo a que segundo con el audio transcrito
- Depende de la salida que le indique en response_format: 'srt', 'vtt', 
- 'verbose_json' es útil porque da mucha más info (útil para el frontend)
-----

## Frontend

- src/core/use-cases

~~~js
import type { AudioToTextResponse } from '../../interfaces';


export const audioToTextUseCase = async( audioFile: File, prompt?: string ) => {

  try {

    const formData = new FormData();
    formData.append('file', audioFile );
    if ( prompt ) {
      formData.append('prompt', prompt );
    }
    


    const resp = await fetch(`${ import.meta.env.VITE_GPT_API }/audio-to-text`, {
      method: 'POST',
      body: formData
    });

    const data = await resp.json() as AudioToTextResponse;
    return data;


  } catch (error) {
    console.log(error);
    return null;
  }


}
~~~

- src/interfaces 

~~~js
// Generated by https://quicktype.io

export interface AudioToTextResponse {
  task:     string;
  language: string;
  duration: number;
  text:     string;
  segments: Segment[];
}

export interface Segment {
  id:                number;
  seek:              number;
  start:             number;
  end:               number;
  text:              string;
  tokens:            number[];
  temperature:       number;
  avg_logprob:       number;
  compression_ratio: number;
  no_speech_prob:    number;
}
~~~

- presentation/pages

~~~js
import { useState } from 'react';
import { GptMessage, MyMessage, TypingLoader, TextMessageBoxFile } from '../../components';
import { audioToTextUseCase } from '../../../core/use-cases';

interface Message {
  text: string;
  isGpt: boolean;
}


export const AudioToTextPage = () => {

  const [isLoading, setIsLoading] = useState(false);
  const [messages, setMessages] = useState<Message[]>([])


  const handlePost = async( text: string, audioFile: File ) => {

    setIsLoading(true);
    setMessages( (prev) => [...prev, { text: text, isGpt: false }] );

    //TODO: UseCase
    const resp = await audioToTextUseCase(audioFile, text);
    setIsLoading(false);

    if ( !resp ) return; // no hay respuesta...

    const gptMessage = `
## Transcripción:
__Duración:__ ${ Math.round( resp.duration )  } segundos
## El texto es:
${ resp.text }
`


    setMessages( (prev) => [
      ...prev,
      { text: gptMessage, isGpt: true }
    ]);

    for( const segment of resp.segments ) {
      const segmentMessage = `
__De ${ Math.round( segment.start ) } a ${ Math.round( segment.end ) } segundos:__
${ segment.text }
`

      setMessages( (prev) => [
        ...prev,
        { text: segmentMessage, isGpt: true }
      ]);
    }
    
    


  }



  return (
    <div className="chat-container">
      <div className="chat-messages">
        <div className="grid grid-cols-12 gap-y-2">
          {/* Bienvenida */}
          <GptMessage text="Hola, ¿qué audio quieres generar hoy?" />

          {
            messages.map( (message, index) => (
              message.isGpt
                ? (
                  <GptMessage key={ index } text={ message.text } />
                )
                : (
                  <MyMessage key={ index } text={ (message.text === '')?'Transcribe el audio': message.text } />
                )
                
            ))
          }

          
          {
            isLoading && (
              <div className="col-start-1 col-end-12 fade-in">
                <TypingLoader />
              </div>
            )
          }
          

        </div>
      </div>


      <TextMessageBoxFile
        onSendMessage={ handlePost }
        placeholder='Escribe aquí lo que deseas'
        disableCorrections
        accept="audio/*"
      />

    </div>
  );
};
~~~

-presentation/components//chat-bubble/GptMessage

~~~js
import Markdown from "react-markdown";

interface Props {
  text: string;
}

export const GptMessage = ({ text }: Props) => {
  return (
    <div className="col-start-1 col-end-9 p-3 rounded-lg">
      <div className="flex flex-row items-start">
        <div className="flex items-center justify-center h-10 w-10 rounded-full bg-green-600 flex-shrink-0">
          G
        </div>
        <div className="relative ml-3 text-sm bg-black bg-opacity-25 pt-3 pb-2 px-4 shadow rounded-xl">
          <Markdown>{text}</Markdown>
        </div>
      </div>
    </div>
  );
};

~~~

-presentation/components//chat-bubble/GptMessageAudio

~~~js
import Markdown from "react-markdown";

interface Props {
  text: string;
  audio: string;
}

export const GptMessageAudio = ({ text, audio }: Props) => {
  return (
    <div className="col-start-1 col-end-9 p-3 rounded-lg">
      <div className="flex flex-row items-start">
        <div className="flex items-center justify-center h-10 w-10 rounded-full bg-green-600 flex-shrink-0">
          G
        </div>
        <div className="relative ml-3 text-sm bg-black bg-opacity-25 pt-3 pb-2 px-4 shadow rounded-xl">
          <Markdown>{text}</Markdown>
          <audio 
            controls
            src={ audio }
            className="w-full"
            autoPlay
          />
        </div>
      </div>
    </div>
  );
};
~~~

-presentation/components//chat-bubble/GptOrthographyMessage

~~~js


interface Props {
  userScore: number;
  errors: string[];
  message: string;
}

export const GptOrthographyMessage = ({ userScore, errors, message }: Props) => {
  return (
    <div className="col-start-1 col-end-9 p-3 rounded-lg">
      <div className="flex flex-row items-start">
        <div className="flex items-center justify-center h-10 w-10 rounded-full bg-green-600 flex-shrink-0">
          G
        </div>
        <div className="relative ml-3 text-sm bg-black bg-opacity-25 pt-3 pb-2 px-4 shadow rounded-xl">

          <h3 className="text-3xl">Puntaje: { userScore }%</h3>
          <p>{ message }</p>

          {
            (errors.length === 0)
            ? <p>No se encontraron errores, perfecto!</p>
            : (
              <>
                <h3 className="text-2xl">Errores encontrados</h3>
                <ul>
                  {
                    errors.map( (error, i) => (
                      <li key={ i }>
                        { error }
                      </li>
                    ))
                  }
                </ul>
              </>
            )


          }

        </div>
      </div>
    </div>
  );
};
~~~

-presentation/components//chat-bubble/MyMessage

~~~js
interface Props {
  text: string;
}

export const MyMessage = ({ text }: Props) => {
  return (
    <div className="col-start-6 col-end-13 p-3 rounded-lg">
      <div className="flex items-center justify-start flex-row-reverse">
        <div className="flex items-center justify-center h-10 w-10 rounded-full bg-indigo-500 flex-shrink-0">
          F
        </div>
        <div className="relative mr-3 text-sm bg-indigo-700 py-2 px-4 shadow rounded-xl">
          <div>{ text }</div>
        </div>
      </div>
    </div>
  );
};
~~~

- components/chat-input/textMessageBox

~~~js
import { FormEvent, useState } from 'react';


interface Props {
  onSendMessage: (message: string)=>void;
  placeholder?: string;
  disableCorrections?: boolean;
}


export const TextMessageBox = ({ onSendMessage, placeholder, disableCorrections = false }: Props) => {

  const [message, setMessage] = useState('')



  const handleSendMessage = (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();

    if ( message.trim().length === 0 ) return;

    onSendMessage( message );
    setMessage('');
  }

  return (
    <form
      onSubmit={ handleSendMessage }
      className="flex flex-row items-center h-16 rounded-xl bg-white w-full px-4"
    >

      <div className="flex-grow">
        <div className="relative w-full">

          <input 
            type="text" 
            autoFocus
            name="message"
            className="flex w-full border rounded-xl text-gray-800 focus:outline-none focus:border-indigo-300 pl-4 h-10"
            placeholder={ placeholder }
            autoComplete={ disableCorrections ? 'on': 'off' }
            autoCorrect={ disableCorrections ? 'on': 'off' }
            spellCheck={ disableCorrections ? 'true': 'false' }
            value={ message }
            onChange={ (e) => setMessage( e.target.value ) }
          />


        </div>
      </div>


      <div className="ml-4">
          <button className="btn-primary">
            <span className="mr-2">Enviar</span>
            <i className="fa-regular fa-paper-plane"></i>
          </button>
      </div>




    </form>
  )
}
~~~

- chat-input/textMessageboxFile

~~~js
import { FormEvent, useRef, useState } from 'react';


interface Props {
  onSendMessage: (message: string, file: File )=>void;
  placeholder?: string;
  disableCorrections?: boolean;
  accept?: string; // image/*
}


export const TextMessageBoxFile = ({ onSendMessage, placeholder, disableCorrections = false, accept }: Props) => {

  const [message, setMessage] = useState('');

  const [selectedFile, setSelectedFile] = useState<File | null>()
  const inputFileRef = useRef<HTMLInputElement>(null);





  const handleSendMessage = (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();

    // if ( message.trim().length === 0 ) return;
    if ( !selectedFile ) return;

    onSendMessage( message, selectedFile );
    setMessage('');
    setSelectedFile(null);
  }

  return (
    <form
      onSubmit={ handleSendMessage }
      className="flex flex-row items-center h-16 rounded-xl bg-white w-full px-4"
    >
      <div className="mr-3">
        <button
          type="button"
          className="flex items-center justify-center text-gray-400 hover:text-gray-600"
          onClick={ () => inputFileRef.current?.click() }
        >
            <i className="fa-solid fa-paperclip text-xl"></i>
        </button>

        <input 
          type="file" 
          ref={ inputFileRef }
          accept={ accept } 
          onChange={ (e) => setSelectedFile( e.target.files?.item(0) ) }
          hidden
      />

      </div>



      <div className="flex-grow">
        <div className="relative w-full">

          <input 
            type="text" 
            autoFocus
            name="message"
            className="flex w-full border rounded-xl text-gray-800 focus:outline-none focus:border-indigo-300 pl-4 h-10"
            placeholder={ placeholder }
            autoComplete={ disableCorrections ? 'on': 'off' }
            autoCorrect={ disableCorrections ? 'on': 'off' }
            spellCheck={ disableCorrections ? 'true': 'false' }
            value={ message }
            onChange={ (e) => setMessage( e.target.value ) }
          />


        </div>
      </div>


      <div className="ml-4">
          <button 
            className="btn-primary"
            disabled={ !selectedFile }
          >
            {
              ( !selectedFile )
               ? <span className="mr-2">Enviar</span>
               : <span className="mr-2"> { selectedFile.name.substring(0,10) + '...' }  </span>
            }
            <i className="fa-regular fa-paper-plane"></i>
          </button>
      </div>




    </form>
  )
}
~~~

- TextMessageBoxSelect

~~~js
import { FormEvent, useState } from 'react';


interface Props {
  onSendMessage: (message: string, selectedOption: string )=>void;
  placeholder?: string;
  disableCorrections?: boolean;
  options: Option[];
}

interface Option {
  id: string;
  text: string;
}



export const TextMessageBoxSelect = ({ onSendMessage, placeholder, disableCorrections = false, options }: Props) => {

  const [message, setMessage] = useState('');
  const [selectedOption, setSelectedOption] = useState<string>('');



  const handleSendMessage = (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();

    if ( message.trim().length === 0 ) return;
    if ( selectedOption === '' ) return;

    onSendMessage( message, selectedOption );
    setMessage('');
  }

  return (
    <form
      onSubmit={ handleSendMessage }
      className="flex flex-row items-center h-16 rounded-xl bg-white w-full px-4"
    >

      <div className="flex-grow">
        <div className="flex">

          <input 
            type="text" 
            autoFocus
            name="message"
            className="w-full border rounded-xl text-gray-800 focus:outline-none focus:border-indigo-300 pl-4 h-10"
            placeholder={ placeholder }
            autoComplete={ disableCorrections ? 'on': 'off' }
            autoCorrect={ disableCorrections ? 'on': 'off' }
            spellCheck={ disableCorrections ? 'true': 'false' }
            value={ message }
            onChange={ (e) => setMessage( e.target.value ) }
          />

          <select 
            name="select"
            className="w-2/5 ml-5 border rounded-xl text-gray-800 focus:outline-none focus:border-indigo-300 pl-4 h-10"
            value={ selectedOption }
            onChange={ e => setSelectedOption( e.target.value ) }
          >
            <option value=''>Seleccione</option>
            {
              options.map( ({ id, text }) => (
                <option key={ id } value={ id }>{ text }</option>
              ))
            }
          </select>


        </div>
      </div>


      <div className="ml-4">
          <button className="btn-primary">
            <span className="mr-2">Enviar</span>
            <i className="fa-regular fa-paper-plane"></i>
          </button>
      </div>




    </form>
  )
}
~~~

- components/loaders/TypingLoader

~~~css
.typing {
  display: block;
  width: 60px;
  height: 40px;
  border-radius: 20px;
  margin: 0 1rem;
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #f2f2f2;
}

.circle {
  display: block;
  height: 10px;
  width: 10px;
  border-radius: 50%;
  background-color: #8d8d8d;
  margin: 3px;
}
.circle.scaling {
  animation: typing 1000ms ease-in-out infinite;
  animation-delay: 3600ms;
}
.circle.bouncing {
  animation: bounce 1000ms ease-in-out infinite;
  animation-delay: 3600ms;
}

.circle:nth-child(1) {
  animation-delay: 0ms;
}

.circle:nth-child(2) {
  animation-delay: 333ms;
}

.circle:nth-child(3) {
  animation-delay: 666ms;
}

@keyframes typing {
  0% {
    transform: scale(1);
  }
  33% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.4);
  }
  100% {
    transform: scale(1);
  }
}

@keyframes bounce {
  0% {
    transform: translateY(0);
  }
  33% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
  100% {
    transform: translateY(0);
  }
}
~~~

- TypingLoader

~~~js
import './TypingLoader.css';

interface Props {
  className?: string;
}


export const TypingLoader = ({ className }: Props) => {
  return (
    <div className={`typing ${ className }`}>
      <span className="circle scaling"></span>
      <span className="circle scaling"></span>
      <span className="circle scaling"></span>
    </div>
  )
}
~~~

- components/sidebar/SideBarMenuItem

~~~js
import { NavLink } from 'react-router-dom';

interface Props {
  to: string;
  icon: string;
  title: string;
  description: string;
}


export const SidebarMenuItem = ({
  to, icon, title, description
}:Props) => {
  return (
    <NavLink
      to={to}
      className={({ isActive }) =>
        isActive
          ? "flex justify-center items-center bg-gray-800 rounded-md p-2 transition-colors"
          : "flex justify-center items-center hover:bg-gray-800 rounded-md p-2 transition-colors"
      }
    >
      <i className={`${icon} text-2xl mr-4 text-indigo-400`}></i>
      <div className="flex flex-col flex-grow">
        <span className="text-white text-lg font-semibold">{title}</span>
        <span className="text-gray-400 text-sm">{description}</span>
      </div>
    </NavLink>
  );
};
~~~


- presentation/layouts/Dashboard (layout)

~~~js
import { NavLink, Outlet } from "react-router-dom";
import { menuRoutes } from '../router/router';
import { SidebarMenuItem } from '../components';

export const DashboardLayout = () => {
  return (
    <main className="flex flex-row mt-7">
      <nav className="hidden sm:flex flex-col ml-5 w-[370px] min-h-[calc(100vh-3.0rem)] bg-white bg-opacity-10 p-5 rounded-3xl">
        <h1 className="font-bold text-lg lg:text-3xl bg-gradient-to-br from-white via-white/50 bg-clip-text text-transparent">
          ReactGPT<span className="text-indigo-500">.</span>
        </h1>
        <span className="text-xl">Bienvenido</span>

        <div className="border-gray-700 border my-3" />

        {/* Opciones del menú */}
        {
          menuRoutes.map( option => (
            <SidebarMenuItem key={option.to} {...option } />
          ))
        }
        
      </nav>

      <section className="mx-3 sm:mx-20 flex flex-col w-full h-[calc(100vh-50px)]  bg-white bg-opacity-10 p-5 rounded-3xl">
        <div className="flex flex-row h-full">
          <div className="flex flex-col flex-auto h-full p-1">
            <Outlet />
          </div>
        </div>
      </section>
    </main>
  );
};
~~~

- presentation/router/router

~~~js
import { Navigate, createBrowserRouter } from 'react-router-dom';
import { OrthographyPage, ProsConsPage, ProsConsStreamPage, TranslatePage, TextToAudioPage, ImageGenerationPage, AssistantPage, ImageTunningPage, AudioToTextPage } from '../pages';
import { DashboardLayout } from '../layouts/DashboardLayout';

export const menuRoutes = [
  {
    to: "/orthography",
    icon: "fa-solid fa-spell-check",
    title: "Ortografía",
    description: "Corregir ortografía",
    component: <OrthographyPage />
  },
  {
    to: "/pros-cons",
    icon: "fa-solid fa-code-compare",
    title: "Pros & Cons",
    description: "Comparar pros y contras",
    component: <ProsConsPage />
  },
  {
    to: "/pros-cons-stream",
    icon: "fa-solid fa-water",
    title: "Como stream",
    description: "Con stream de mensajes",
    component: <ProsConsStreamPage />
  },
  {
    to: "/translate",
    icon: "fa-solid fa-language",
    title: "Traducir",
    description: "Textos a otros idiomas",
    component: <TranslatePage />
  },
  {
    to: "/text-to-audio",
    icon: "fa-solid fa-podcast",
    title: "Texto a audio",
    description: "Convertir texto a audio",
    component: <TextToAudioPage />
  },
  {
    to: "/audio-to-text",
    icon: "fa-solid fa-comment-dots",
    title: "Audio a texto",
    description: "Convertir audio a texto",
    component: <AudioToTextPage />
  },
  {
    to: "/image-generation",
    icon: "fa-solid fa-image",
    title: "Imágenes",
    description: "Generar imágenes",
    component: <ImageGenerationPage />
  },
  {
    to: "/image-tunning",
    icon: "fa-solid fa-wand-magic",
    title: "Editar imagen",
    description: "Generación continua",
    component: <ImageTunningPage />
  },
  
  {
    to: "/assistant",
    icon: "fa-solid fa-user",
    title: "Asistente",
    description: "Información del asistente",
    component: <AssistantPage />
  },
];


export const router = createBrowserRouter([
  {
    path: "/",
    element: <DashboardLayout />,
    children: [
      ...menuRoutes.map( route => ({
        path: route.to,
        element: route.component
      })),
      {
        path: '',
        element: <Navigate to={ menuRoutes[0].to } />
      }

    ],
  }
])
~~~

- index.css

~~~js
@tailwind base;
@tailwind components;
@tailwind utilities;

html, body {
  background-color: #000000;
  color: white;
  font-family: 'Open Sans', sans-serif;
  
}


h1 {
  @apply text-3xl font-bold mb-4;
}

p {
  @apply mb-4;
}

ul {
  @apply list-disc list-inside;
}

strong {
  @apply font-bold text-indigo-400 text-xl;
}

em {
  @apply italic text-pink-500;
}


.btn-primary {
  @apply bg-indigo-500 text-white font-bold py-2 px-4 rounded-xl hover:bg-indigo-700 transition-all duration-200 ease-in-out;
}

.btn-primary:disabled {
  @apply bg-indigo-500 text-white font-bold py-2 px-4 rounded-xl opacity-50 cursor-not-allowed;
}

.chat-container {
  @apply flex flex-col flex-auto flex-shrink-0 rounded-2xl bg-white bg-opacity-5 h-full p-4;
}

.chat-messages {
  @apply flex flex-col h-full overflow-x-auto mb-4 overflow-scroll;
}


/* Animations */

.fade-in { animation: fadeIn .3s; }

@keyframes fadeIn {
  0% { opacity: 0; }
  100% { opacity: 1; }
}
~~~

- main

~~~js
import React from 'react'
import ReactDOM from 'react-dom/client'

import { ReactGPT } from './ReactGPT';
import './index.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ReactGPT />
  </React.StrictMode>,
)
~~~

- ReactGPT

~~~js
import { RouterProvider } from 'react-router-dom';
import { router } from './presentation/router/router';

export const ReactGPT = () => {
  return (
    <RouterProvider router={ router } />
  )
}
~~~

- index.html

~~~html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ReactGPT</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
~~~




